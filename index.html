<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Reservasi | Mahika Trans</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#065084">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="inputin.css">
</head>
<body>

<div class="header-curvy">
    <h2>MAHIKA TRANS</h2>
    <p>Reservasi Tiket Online</p>
</div>

<div class="form-container">
    <div class="card-input">
        <div class="group-field"><label>Nama Penumpang</label><input type="text" id="nama" placeholder="Nama lengkap"></div>
        <div class="row-flex">
            <div class="group-field half"><label>No. WhatsApp</label><input type="tel" id="whatsapp" placeholder="0812..."></div>
            <div class="group-field half"><label>Kursi</label><input type="text" id="kursi" placeholder="1A"></div>
        </div>
        <div class="group-field"><label>Armada</label><input type="text" id="armada" placeholder="Mahika Jaya"></div>
        <div class="group-field"><label>Tujuan</label><input type="text" id="tujuan" placeholder="Kota Tujuan"></div>
        <div class="group-field"><label>Harga</label><input type="number" id="harga" placeholder="250000"></div>
        <div class="row-flex">
            <div class="group-field half"><label>Tanggal</label><input type="date" id="tgl_only"></div>
            <div class="group-field half"><label>Jam</label><input type="text" id="jam_only" placeholder="17:30"></div>
        </div>
        <button id="btnSimpan" class="btn-save">SIMPAN & KIRIM TIKET</button>
    </div>
</div>

<div class="nav-bottom">
    <a href="pwa-dash.html"><i class="fas fa-house"></i>Home</a>
    <a href="#" class="active"><i class="fas fa-plus-circle"></i>Booking</a>
    <a href="pwa-manifes.html"><i class="fas fa-list"></i>Manifes</a>
    <a href="pwa-komisi.html"><i class="fas fa-wallet"></i>Komisi</a>
    <a href="#" id="logoutBtn"><i class="fas fa-power-off"></i>Off</a>
</div>

<div id="modalSukses" class="modal">
    <div class="modal-content">
        <i class="fas fa-certificate icon-check"></i>
        <h3 style="font-weight:700; margin:0; color: #065084;">BERHASIL!</h3>
        <p style="font-size:12px; color:#777; margin-bottom:25px;">Tiket telah tersimpan ke sistem.</p>
        <a id="linkWA" href="#" target="_blank" class="btn-modal btn-wa"><i class="fab fa-whatsapp"></i> KIRIM KE WA</a>
        <a href="pwa-manifes.html" class="btn-modal btn-manifes">BUKA MANIFES</a>
        <button onclick="location.reload()" style="background:none; border:none; color:#065084; font-size:11px; font-weight:600; cursor:pointer; margin-top:10px;">INPUT BARU</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyAmTAWHcHpolaIHegLceyMqExVgzufJzaU", 
        authDomain: "mahika-trans.firebaseapp.com", 
        projectId: "mahika-trans", 
        storageBucket: "mahika-trans.firebasestorage.app", 
        appId: "1:1087881066133:web:148d51c88f1de3466ecd9c" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    document.getElementById('tgl_only').valueAsDate = new Date();

    document.getElementById('btnSimpan').onclick = async function() {
        const btn = this;
        const data = {
            nama: document.getElementById('nama').value,
            wa: document.getElementById('whatsapp').value,
            kursi: document.getElementById('kursi').value,
            armada: document.getElementById('armada').value,
            tujuan: document.getElementById('tujuan').value,
            harga: document.getElementById('harga').value,
            tgl: document.getElementById('tgl_only').value,
            jam: document.getElementById('jam_only').value
        };

        if(!data.nama || !data.wa) return alert("Nama & WA harus diisi!");

        btn.innerText = "SEDANG MENYIMPAN...";
        btn.disabled = true;

        const randomID = Math.floor(100000 + Math.random() * 900000).toString();

        try {
            await setDoc(doc(db, "bookings", randomID), {
                ...data,
                jam: data.jam + " WIB",
                createdAt: serverTimestamp()
            });

            const linkEtiket = `https://go.mahikatrans.my.id/${randomID}`;
            const textWA = `Halo, *${data.nama}*..%0A` +
                           `Berikut adalah E-Tiket Mahika Trans Anda.%0A%0A` +
                           `Kode Booking: *MT-${randomID}*%0A` +
                           `----------------------------------------%0A` +
                           `${linkEtiket}%0A` +
                           `----------------------------------------%0A%0A` +
                           `Simpan link ini untuk ditunjukkan ke petugas saat keberangkatan.%0A` +
                           `Terimakasih.`;

            let formattedWA = data.wa.startsWith('0') ? '62' + data.wa.substring(1) : data.wa;
            document.getElementById('linkWA').href = `https://wa.me/${formattedWA}?text=${textWA}`;
            document.getElementById('modalSukses').style.display = 'flex';

        } catch (e) { 
            alert("Error: " + e.message); 
        } finally { 
            btn.innerText = "SIMPAN & KIRIM TIKET"; 
            btn.disabled = false; 
        }
    }

    document.getElementById('logoutBtn').onclick = (e) => {
        e.preventDefault();
        signOut(auth).then(() => location.href = "login.html");
    }
</script>
</body>
</html>
